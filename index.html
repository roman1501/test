<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Status Panel (Telegram WebApp)</title>

  <!-- Telegram SDK (–º–æ–∂–µ –±—É—Ç–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ–π, —è–∫—â–æ –≤—ñ–¥–∫—Ä–∏—î—à –ù–ï –≤ Telegram; UI –≤—Å–µ –æ–¥–Ω–æ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏–º–µ) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root { --border:#e5e7eb; --muted:#6b7280; --ok:#22c55e; --bad:#ef4444; --bg:#ffffff; --bg-soft:#f9fafb; --shadow:0 6px 18px rgba(0,0,0,.06); }
    * { box-sizing: border-box; }
    html, body { margin:0; background:var(--bg); color:#111827; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .wrap { padding:16px; max-width:920px; margin:0 auto; }
    .top { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:12px; }
    .banner { padding:8px 12px; border:1px solid var(--border); border-radius:10px; background:var(--bg-soft); }
    .global { padding:8px 12px; border-radius:10px; font-weight:700; border:1px solid var(--border); }
    .global.ok { background:#e6ffed; border-color:#b7ebc6; }
    .global.panic { background:#ffecec; border-color:#ffb3b3; color:#a40000; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(220px, 1fr)); gap:12px; }
    .card { border:1px solid var(--border); border-radius:12px; padding:12px; background:#fff; box-shadow:var(--shadow); display:flex; flex-direction:column; gap:8px; }
    .head { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .code { display:flex; align-items:center; gap:8px; font-weight:700; }
    .dot { width:12px; height:12px; border-radius:50%; border:1px solid #c7c7c7; }
    .green { background:var(--ok); } .red { background:var(--bad); }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    button { cursor:pointer; padding:8px 10px; border:1px solid var(--border); border-radius:10px; background:#fff; font-weight:600; }
    button:disabled { opacity:.55; cursor:not-allowed; }
    .who { font-size:13px; color:#0f172a; background:#f3f4f6; border:1px dashed #e5e7eb; border-radius:10px; padding:6px 8px; }
    .who.empty { color:var(--muted); }
    .footer { margin-top:16px; font-size:12px; color:var(--muted); }
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div id="banner" class="banner">‚Ä¶</div>
    <div id="global" class="global ok">–í—Å–µ —Å–ø–æ–∫—ñ–π–Ω–æ</div>
  </div>

  <div id="grid" class="grid"></div>

  <div class="footer">
    –†–µ–∞–ª-—Ç–∞–π–º: –≤—Å—ñ –∑–º—ñ–Ω–∏ –≤–∏–¥–Ω–æ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è. –Ø–∫—â–æ –Ω–µ –ø—ñ–¥—Å—Ç–∞–≤–∏—à Edge Functions ‚Äî –±–æ—Ç –ø—Ä–æ—Å—Ç–æ –Ω–µ –ø–∏—Å–∞—Ç–∏–º–µ —É Telegram (–∞–ª–µ —Å—Ç–∞—Ç—É—Å–∏ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è).
  </div>
</div>

<script>
/* ================== CONFIG ‚Äî –ó–ê–ú–Ü–ù–ò –¶–Ü –ó–ù–ê–ß–ï–ù–ù–Ø ================== */
const SUPABASE_URL  = "https://YOUR-PROJECT-REF.supabase.co";   // Settings ‚Üí API ‚Üí Project URL
const SUPABASE_ANON = "YOUR-ANON-PUBLIC-KEY";                   // Settings ‚Üí API ‚Üí anon public

// –Ø–∫—â–æ –ù–ï –º–∞—î—à Edge Functions ‚Äî –ª–∏—à–∏ "" (–ø–æ—Ä–æ–∂–Ω—ñ–π —Ä—è–¥–æ–∫) ‚Äî —Ç–æ–¥—ñ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—ñ–¥—É—Ç—å –Ω–∞–ø—Ä—è–º—É –≤ —Ç–∞–±–ª–∏—Ü—é
const SET_STATUS_FUNCTION_URL = "";  // –Ω–∞–ø—Ä–∏–∫–ª–∞–¥: "https://xxxx.functions.supabase.co/set-status"
const CHECK_IN_FUNCTION_URL   = "";  // –Ω–∞–ø—Ä–∏–∫–ª–∞–¥: "https://xxxx.functions.supabase.co/check-in"

// –Ø–∫—ñ —Ä–æ–∑–¥—ñ–ª–∏ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ (–º–æ–∂–µ—à –º—ñ–Ω—è—Ç–∏)
const SECTIONS = ['1.1','2.1','3.1','4.1','4.2'];
/* ================================================================= */

const tg = window.Telegram?.WebApp;
try { tg?.expand(); } catch {}

const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

const gridEl   = document.getElementById('grid');
const globalEl = document.getElementById('global');
const bannerEl = document.getElementById('banner');

const user = tg?.initDataUnsafe?.user;
const userName = user
  ? (user.username ? '@'+user.username : [user.first_name, user.last_name].filter(Boolean).join(' ') || ('id:'+user.id))
  : '–ì—ñ—Å—Ç—å';
bannerEl.textContent = `–í–∏: ${userName}`;

let lastSections = [];
let checkinsByCode = new Map();

function setGlobal(items) {
  const anyRed = items.some(i => i.status === 'red');
  globalEl.textContent = anyRed ? '–®–£–•–ï–†' : '–í—Å–µ —Å–ø–æ–∫—ñ–π–Ω–æ';
  globalEl.className = 'global ' + (anyRed ? 'panic' : 'ok');
}

function cardTemplate(row) {
  const { code, status, last_changed_name, updated_at } = row;
  const list = checkinsByCode.get(code) || [];
  const who  = list.length ? `üë£ ${list.join(', ')}` : '–ù—ñ—Ö—Ç–æ –Ω–µ –≤—ñ–¥–º—ñ—Ç–∏–≤—Å—è';
  const time = updated_at ? new Date(updated_at).toLocaleTimeString() : '';
  return `
    <div class="card" data-code="${code}" data-status="${status}">
      <div class="head">
        <div class="code">
          <div class="dot ${status === 'red' ? 'red' : 'green'}"></div>
          <div>${code}</div>
        </div>
        <div style="font-size:12px; color:#6b7280;">
          ${last_changed_name ? `–û—Å—Ç–∞–Ω–Ω—è –∑–º—ñ–Ω–∞: ${last_changed_name}` : ''} ${time ? `‚Ä¢ ${time}` : ''}
        </div>
      </div>
      <div class="actions">
        <button class="toGreen">–ó–µ–ª–µ–Ω–∏–π</button>
        <button class="toRed">–ß–µ—Ä–≤–æ–Ω–∏–π</button>
        <button class="imHere">–Ø —Ç—É—Ç</button>
      </div>
      <div class="who ${list.length ? '' : 'empty'}">${who}</div>
    </div>
  `;
}

function renderSections(items) {
  const byCode = new Map(items.map(i => [i.code, i]));
  const ordered = SECTIONS.map(c => byCode.get(c)).filter(Boolean);

  gridEl.innerHTML = ordered.map(cardTemplate).join('');
  setGlobal(ordered);

  gridEl.querySelectorAll('.card').forEach(el => {
    const code = el.getAttribute('data-code');
    const current = el.getAttribute('data-status');

    const btnG = el.querySelector('.toGreen');
    const btnR = el.querySelector('.toRed');
    const btnH = el.querySelector('.imHere');

    btnG.disabled = current === 'green';
    btnR.disabled = current === 'red';

    btnG.onclick = () => updateStatus(code, 'green', current);
    btnR.onclick = () => updateStatus(code, 'red',  current);
    btnH.onclick = () => checkIn(code);
  });

  lastSections = ordered;
}

function renderCheckins(list) {
  checkinsByCode = new Map();
  for (const row of (list || [])) {
    if (!row.code) continue;
    const arr = checkinsByCode.get(row.code) || [];
    arr.push(row.user_name);
    checkinsByCode.set(row.code, arr);
  }
  renderSections(lastSections);
}

async function loadSections() {
  const { data, error } = await client.from('sections').select('*').order('code');
  if (error) { console.error(error); return; }
  renderSections(data || []);
}

async function loadCheckins() {
  const { data, error } = await client.from('section_checkins').select('*');
  if (error) { console.error(error); return; }
  renderCheckins(data || []);
}

let chSec, chChk;
function subscribeRealtime() {
  if (chSec) client.removeChannel(chSec);
  if (chChk) client.removeChannel(chChk);

  chSec = client.channel('realtime:sections')
    .on('postgres_changes', { event:'*', schema:'public', table:'sections' }, loadSections)
    .subscribe();

  chChk = client.channel('realtime:checkins')
    .on('postgres_changes', { event:'*', schema:'public', table:'section_checkins' }, loadCheckins)
    .subscribe();
}

let clickCooldown = false;
function cooldown(ms=800) {
  clickCooldown = true;
  setTimeout(() => clickCooldown = false, ms);
}

async function updateStatus(code, status, current) {
  if (clickCooldown) return;
  if (status === current) return;

  try { tg?.HapticFeedback?.impactOccurred?.('medium'); } catch {}
  cooldown();

  // –Ø–∫—â–æ —î Edge Function ‚Äî –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —ó—ó (—â–æ–± –≤—ñ–¥–ø—Ä–∞–≤–ª—è–ª–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ Telegram)
  if (SET_STATUS_FUNCTION_URL) {
    try {
      const res = await fetch(SET_STATUS_FUNCTION_URL, {
        method: 'POST',
        headers: { 'content-type':'application/json' },
        body: JSON.stringify({ code, status, tgInitData: tg?.initData || '' })
      });
      const j = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(j.error || 'Request failed');
      // Realtime —Å–∞–º –æ–Ω–æ–≤–∏—Ç—å –≤—Å—ñ—Ö
      return;
    } catch (e) {
      console.error(e);
      alert('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü—ñ—é. –ü–µ—Ä–µ–≤—ñ—Ä URL/—Å–µ–∫—Ä–µ—Ç–∏.');
      return;
    }
  }

  // –Ü–Ω–∞–∫—à–µ ‚Äî –ø—Ä—è–º–∏–π –∞–ø–¥–µ–π—Ç —Ç–∞–±–ª–∏—Ü—ñ (–ø—Ä–∞—Ü—é—î –±–µ–∑ —Ñ—É–Ω–∫—Ü—ñ–π, –∞–ª–µ –±–µ–∑ Telegram-—Å–ø–æ–≤—ñ—â–µ–Ω—å)
  const { error } = await client.from('sections')
    .update({ status, updated_at: new Date().toISOString() })
    .eq('code', code);
  if (error) {
    console.error(error);
    alert('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –≤ —Ç–∞–±–ª–∏—Ü—ñ.');
  }
}

async function checkIn(code) {
  if (clickCooldown) return;
  cooldown(500);

  // –Ø–∫—â–æ —î Edge Function ‚Äî —à–ª–µ–º–æ —á–µ—Ä–µ–∑ –Ω–µ—ó (—ñ–∑ –≤–∞–ª—ñ–¥–∞—Ü—ñ—î—é Telegram initData)
  if (CHECK_IN_FUNCTION_URL) {
    try {
      const res = await fetch(CHECK_IN_FUNCTION_URL, {
        method: 'POST',
        headers: { 'content-type':'application/json' },
        body: JSON.stringify({ code, tgInitData: tg?.initData || '' })
      });
      const j = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(j.error || 'Request failed');
      return; // Realtime –ø—ñ–¥—Ç—è–≥–Ω–µ –∑–º—ñ–Ω–∏
    } catch (e) {
      console.error(e);
      alert('–ü–æ–º–∏–ª–∫–∞ —á–µ–∫—ñ–Ω—É —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü—ñ—é. –ü–µ—Ä–µ–≤—ñ—Ä URL/—Å–µ–∫—Ä–µ—Ç–∏.');
      return;
    }
  }

  // –Ü–Ω–∞–∫—à–µ ‚Äî –ø—Ä—è–º–∏–π upsert (–ø—Ä–∞—Ü—é—î –±–µ–∑ —Ñ—É–Ω–∫—Ü—ñ–π)
  const user_name = userName || '–ì—ñ—Å—Ç—å';
  const { error } = await client.from('section_checkins').upsert({
    user_id: 0,              // –±–µ–∑ Telegram WebApp –Ω–µ–º–∞—î user.id ‚Üí —Å—Ç–∞–≤–∏–º–æ 0 –∞–±–æ —Ä–æ–±–∏–º–æ random
    user_name,
    code,
    checked_at: new Date().toISOString()
  });
  if (error) {
    console.error(error);
    alert('–ü–æ–º–∏–ª–∫–∞ —á–µ–∫—ñ–Ω—É –≤ —Ç–∞–±–ª–∏—Ü—ñ.');
  }
}

// –°—Ç–∞—Ä—Ç
(async function start() {
  await Promise.all([loadSections(), loadCheckins()]);
  subscribeRealtime();
})();
</script>
</body>
</html>