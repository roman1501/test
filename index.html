<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Статуси — Telegram WebApp</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root { --bg:#fff; --fg:#111; --muted:#666; --line:#eaeaea; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--fg); }
  .wrap { padding: 16px; max-width: 760px; margin: 0 auto; }
  h1 { font-size: 20px; margin: 0 0 12px; }
  .note { color:var(--muted); font-size:12px; margin-bottom:12px; }
  .row { display:grid; grid-template-columns: 1fr auto; align-items:center; gap:12px; padding:12px 0; border-bottom:1px solid var(--line); }
  .title { display:flex; align-items:center; gap:10px; }
  .dot { width:14px; height:14px; border-radius:50%; box-shadow: 0 0 0 2px #00000010; }
  .green { background:#18c964; box-shadow:0 0 0 2px #18c96422; }
  .red { background:#ff3b30; box-shadow:0 0 0 2px #ff3b3022; }
  .btns { display:flex; gap:8px; flex-wrap:wrap; }
  button { padding:8px 12px; border:1px solid var(--line); background:#fafafa; border-radius:10px; cursor:pointer; }
  button:hover { background:#f0f0f0; }
  .controls { display:flex; gap:8px; flex-wrap:wrap; margin:14px 0 8px; }
  input { padding:8px 10px; border:1px solid var(--line); border-radius:10px; }
  .footer-note { color:var(--muted); font-size:12px; margin-top:10px; }
  .ok { color:#18c964; }
  .err { color:#ff3b30; }
</style>
</head>
<body>
<div class="wrap">
  <h1>Онлайн-статуси</h1>
  <div class="note">Зміни миттєво розлітаються всім відкритим екранам. Для “ШУХЕР” введи пароль.</div>

  <div class="controls">
    <input id="name" placeholder="Ваше ім’я" />
    <input id="password" type="password" placeholder="Пароль для змін" />
    <button id="refresh">Оновити</button>
  </div>
  <div class="footer-note" id="who"></div>

  <div id="list"></div>

  <div class="footer-note">Після натискання “ШУХЕР” прилітає повідомлення від бота: <b>4.1 ШУХЕР (ім’я)</b>.</div>
  <div id="msg" class="footer-note"></div>
</div>

<script>
  // --- Telegram theme → CSS vars
  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.expand();
    const p = tg.themeParams || {};
    const map = (k, def) => p[k] || def;
    document.documentElement.style.setProperty('--bg', map('bg_color', '#ffffff'));
    document.documentElement.style.setProperty('--fg', map('text_color', '#111111'));
    document.documentElement.style.setProperty('--muted', map('hint_color', '#666666'));
    document.documentElement.style.setProperty('--line', map('section_separator_color', '#eaeaea'));
  }

  const SUPABASE_URL = 'https://xlrihkophbzbrsknimin.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhscmloa29waGJ6YnJza25pbWluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2NTc4OTksImV4cCI6MjA3NjIzMzg5OX0.mQBCCYgcbKwoN6HZjvmwGi4F995t0HZ9Ty3gZnjbtis';
  const SET_STATUS_FUNCTION_URL = 'https://xlrihkophbzbrsknimin.supabase.co/functions/v1/set-status';

  const { createClient } = window.supabase;
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

  const elList = document.getElementById('list');
  const elMsg  = document.getElementById('msg');
  const elName = document.getElementById('name');
  const elPass = document.getElementById('password');
  const elWho  = document.getElementById('who');

  // Prefill name from Telegram user
  try {
    const u = tg?.initDataUnsafe?.user;
    if (u) {
      const full = [u.first_name, u.last_name].filter(Boolean).join(' ');
      elName.value = full || u.username || '';
      elWho.textContent = `Ви: ${elName.value || '—'}`;
    }
  } catch {}

  document.getElementById('refresh').onclick = () => load();

  async function load() {
    const { data, error } = await supabase
      .from('sections')
      .select('*')
      .order('code', { ascending: true });

    if (error) {
      show(`Помилка завантаження: ${error.message}`, true);
      return;
    }
    render(data || []);
  }

  function render(items) {
    elList.innerHTML = '';
    items.forEach(it => {
      const row = document.createElement('div');
      row.className = 'row';

      const left = document.createElement('div');
      left.className = 'title';
      const dot = document.createElement('span');
      dot.className = 'dot ' + (it.status === 'red' ? 'red' : 'green');
      const ttl = document.createElement('div');
      ttl.textContent = `${it.code} — ${it.title}`;
      left.appendChild(dot);
      left.appendChild(ttl);

      const right = document.createElement('div');
      right.className = 'btns';
      const bRed = document.createElement('button');
      bRed.textContent = 'ШУХЕР (червоний)';
      bRed.onclick = () => changeStatus(it.code, 'red');
      const bGreen = document.createElement('button');
      bGreen.textContent = 'Повернути зелений';
      bGreen.onclick = () => changeStatus(it.code, 'green');
      right.appendChild(bRed);
      right.appendChild(bGreen);

      row.appendChild(left);
      row.appendChild(right);
      elList.appendChild(row);
    });
  }

  async function changeStatus(code, newStatus) {
    const name = (elName.value || '').trim();
    const password = (elPass.value || '').trim();
    if (!name) { show('Вкажіть ім’я', true); return; }
    if (!password) { show('Вкажіть пароль', true); return; }

    try {
      const res = await fetch(SET_STATUS_FUNCTION_URL, {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ code, newStatus, name, password })
      });
      const json = await res.json();
      if (!res.ok) throw new Error(json?.error || res.statusText);
      show('Оновлено ✔');
      if (tg) tg.HapticFeedback.impactOccurred('medium');
    } catch (e) {
      show('Помилка: ' + e.message, true);
      if (tg) tg.HapticFeedback.notificationOccurred('error');
    }
  }

  function show(text, isErr=false) {
    elMsg.className = 'footer-note ' + (isErr ? 'err' : 'ok');
    elMsg.textContent = text;
    clearTimeout(show._t);
    show._t = setTimeout(() => { elMsg.textContent = ''; }, 4000);
  }

  // Initial load:
  load();

  // Realtime updates:
  supabase.channel('sections-realtime')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'sections' }, (payload) => {
      // payload.new містить новий рядок — перезавантажимо список
      load();
      if (tg) tg.HapticFeedback.impactOccurred('light');
    })
    .subscribe();
</script>
</body>
</html>
