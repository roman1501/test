<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>–°—Ç–∞—Ç—É—Å–∏ ‚Äî Telegram WebApp</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#fff; --fg:#111; --muted:#6b7280; --line:#ececec;
    --ok:#18c964; --err:#ff3b30; --card:#fafafa; --tap:#f3f4f6;
    --radius:14px; --radius-sm:10px;
    --shadow:0 1px 3px rgba(0,0,0,.06), 0 1px 2px rgba(0,0,0,.04);
    --pad:16px; --gap:12px;
    --h1: clamp(18px, 4vw, 22px);
    --t1: clamp(14px, 3.6vw, 16px);
    --t2: clamp(12px, 3.2vw, 14px);
  }
  @media (prefers-reduced-motion: no-preference){
    .a-fade{ animation: fade .18s ease-out both; }
    @keyframes fade { from{opacity:.0; transform: translateY(4px)} to{opacity:1; transform:none} }
    .pulse { animation: pulse 1s ease-in-out 1; }
    @keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.15)} 100%{transform:scale(1)} }
  }
  html,body{ height:100%; }
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Segoe UI Emoji";
    background:var(--bg); color:var(--fg);
  }
  .wrap{ padding-bottom: max(12px, env(safe-area-inset-bottom)); max-width: 840px; margin: 0 auto; }

  /* Sticky top controls */
  .topbar{
    position: sticky; top:0; z-index:10;
    backdrop-filter: saturate(120%) blur(6px);
    background: color-mix(in oklab, var(--bg) 84%, transparent);
    border-bottom:1px solid var(--line);
  }
  .topbar-inner{ padding: calc(env(safe-area-inset-top) + 10px) var(--pad) 10px; }
  h1{ font-size:var(--h1); margin:0 0 8px; line-height:1.2; }
  .note{ color:var(--muted); font-size:var(--t2); margin:0 0 10px; }

  .controls{
    display:grid; gap:10px;
    grid-template-columns: 1fr 1fr auto;
    align-items:center;
  }
  @media (max-width:560px){ .controls{ grid-template-columns: 1fr; } }
  input{
    width:100%; padding:12px 12px; border:1px solid var(--line);
    border-radius: var(--radius-sm); background:var(--card); font-size:var(--t1); outline:none;
  }
  input:focus{ box-shadow: 0 0 0 2px color-mix(in oklab, var(--fg) 10%, transparent); }
  .btn{
    padding:12px 14px; border:1px solid var(--line); background:var(--tap);
    border-radius: var(--radius-sm); cursor:pointer; font-size:var(--t1);
    user-select:none; -webkit-tap-highlight-color: transparent;
  }
  .btn:active{ transform: translateY(1px); }
  .btn-primary{ background:var(--fg); color:var(--bg); border-color: var(--fg); }
  .who{ color:var(--muted); font-size:var(--t2); margin-top:6px; }

  /* List */
  #list{ padding: 12px var(--pad); display:grid; gap:10px; }
  .row{
    display:grid; gap:10px;
    grid-template-columns: 1fr auto;
    align-items:start;
    border:1px solid var(--line);
    border-radius: var(--radius);
    padding:12px;
    background: var(--bg);
    box-shadow: var(--shadow);
  }
  @media (max-width:680px){ .row{ grid-template-columns: 1fr; } }

  .title{ display:flex; align-items:center; gap:10px; min-width:0; }
  .dot{ flex: 0 0 16px; width:16px; height:16px; border-radius:50%; box-shadow: 0 0 0 2px #00000010; }
  .green{ background: var(--ok); box-shadow: 0 0 0 2px color-mix(in oklab, var(--ok) 20%, transparent); }
  .red{ background: var(--err); box-shadow: 0 0 0 2px color-mix(in oklab, var(--err) 20%, transparent); }
  .ttl{ font-size:var(--t1); font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

  /* Actions: status + check-in */
  .actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .seg{
    display:flex; overflow:hidden; border-radius: 12px; border:1px solid var(--line); background: var(--card);
  }
  .seg .seg-btn{
    appearance:none; border:none; background:transparent; padding:12px 14px; font-size:var(--t1);
    cursor:pointer; min-width: 120px; text-align:center;
  }
  @media (max-width:560px){ .seg{ width:100%; } .seg .seg-btn{ flex:1; min-width:auto; } }
  .seg .seg-btn + .seg-btn{ border-left:1px solid var(--line); }
  .seg .danger{ color:var(--err); font-weight:600; }
  .seg .ok{ color:var(--ok); font-weight:600; }

  /* Check-ins */
  .who-line{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .chips{
    display:flex; gap:6px; flex-wrap:wrap; align-items:center; max-width:100%;
  }
  .chip{
    display:inline-flex; align-items:center; justify-content:center;
    padding:6px 8px; border-radius:999px; background:var(--card);
    border:1px solid var(--line); font-size:var(--t2); line-height:1; white-space:nowrap;
  }
  .chip-badge{ font-weight:700; }
  .me{ border-color: color-mix(in oklab, var(--ok) 40%, var(--line)); background: color-mix(in oklab, var(--ok) 12%, var(--card)); }
  .check-btn{
    padding:10px 12px; border-radius:10px; border:1px solid var(--line);
    background:var(--tap); font-size:var(--t2);
  }
  .check-btn.primary{ background: var(--ok); color:#fff; border-color: var(--ok); }
  .check-btn.ghost{ background: transparent; }

  .footer-note{ color:var(--muted); font-size:var(--t2); padding: 0 var(--pad); margin: 6px 0 10px; }
  .msg { padding: 8px var(--pad) max(8px, env(safe-area-inset-bottom)); }
  .ok-t{ color:var(--ok); } .err-t{ color:var(--err); }

  /* Skeleton */
  .skeleton{ border:1px solid var(--line); border-radius: var(--radius); padding:12px; background: var(--card); position:relative; overflow:hidden; }
  .sk-line{ height:14px; background:linear-gradient(90deg, #eee, #f7f7f7, #eee); border-radius:8px; }
  .sk-gap{ height:10px; }
</style>
</head>
<body>
  <div class="wrap">

    <div class="topbar">
      <div class="topbar-inner">
        <h1>–û–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å–∏</h1>
        <p class="note">–ó–º—ñ–Ω–∏ –º–∏—Ç—Ç—î–≤–æ —Ä–æ–∑–ª—ñ—Ç–∞—é—Ç—å—Å—è –≤—Å—ñ–º –≤—ñ–¥–∫—Ä–∏—Ç–∏–º –µ–∫—Ä–∞–Ω–∞–º. –î–ª—è ‚Äú–®–£–•–ï–†‚Äù –≤–≤–µ–¥–∏ –ø–∞—Ä–æ–ª—å. –¢–µ–ø–µ—Ä –º–æ–∂–Ω–∞ –≤—ñ–¥–º—ñ—á–∞—Ç–∏—Å—è, —Ö—Ç–æ –¥–µ üëá</p>

        <div class="controls">
          <input id="name" placeholder="–í–∞—à–µ —ñ–º‚Äô—è" inputmode="text" autocomplete="name" />
          <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å –¥–ª—è –∑–º—ñ–Ω" autocomplete="current-password" />
          <button id="refresh" class="btn btn-primary">–û–Ω–æ–≤–∏—Ç–∏</button>
        </div>
        <div class="who" id="who"></div>
      </div>
    </div>

    <div id="list">
      <div class="skeleton a-fade"><div class="sk-line" style="width:60%"></div><div class="sk-gap"></div><div class="sk-line" style="width:40%"></div></div>
      <div class="skeleton a-fade"><div class="sk-line" style="width:72%"></div><div class="sk-gap"></div><div class="sk-line" style="width:35%"></div></div>
    </div>

    <div class="footer-note">–ü—ñ—Å–ª—è ‚Äú–®–£–•–ï–†‚Äù —â–µ –ª–µ—Ç–∏—Ç—å –±–æ—Ç-–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: <b>4.1 –®–£–•–ï–† (—ñ–º‚Äô—è)</b>. –í—ñ–¥–º—ñ—Ç–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—é—Ç—å—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ.</div>
    <div id="msg" class="footer-note msg"></div>
  </div>

<script>
  // Telegram theme ‚Üí CSS
  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.expand?.();
    const p = tg.themeParams || {};
    const map = (k, def) => p[k] || def;
    document.documentElement.style.setProperty('--bg',    map('bg_color', '#ffffff'));
    document.documentElement.style.setProperty('--fg',    map('text_color', '#111111'));
    document.documentElement.style.setProperty('--muted', map('hint_color', '#6b7280'));
    document.documentElement.style.setProperty('--line',  map('section_separator_color', '#ececec'));
  }

  // Supabase/Functions
  const SUPABASE_URL = 'https://xlrihkophbzbrsknimin.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhscmloa29waGJ6YnJza25pbWluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2NTc4OTksImV4cCI6MjA3NjIzMzg5OX0.mQBCCYgcbKwoN6HZjvmwGi4F995t0HZ9Ty3gZnjbtis';
  const SET_STATUS_FUNCTION_URL = 'https://xlrihkophbzbrsknimin.supabase.co/functions/v1/set-status';
  const CHECK_IN_FUNCTION_URL   = 'https://xlrihkophbzbrsknimin.supabase.co/functions/v1/check-in';

  const { createClient } = window.supabase;
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

  // Elements
  const elList = document.getElementById('list');
  const elMsg  = document.getElementById('msg');
  const elName = document.getElementById('name');
  const elPass = document.getElementById('password');
  const elWho  = document.getElementById('who');

  // Prefill name from Telegram user
  try {
    const u = tg?.initDataUnsafe?.user;
    if (u) {
      const full = [u.first_name, u.last_name].filter(Boolean).join(' ');
      elName.value = full || u.username || '';
      elWho.textContent = `–í–∏: ${elName.value || '‚Äî'}`;
    }
  } catch {}

  document.getElementById('refresh').onclick = () => load();

  // Debounce
  function debounce(fn, ms=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

  // --- DATA STATE
  let presentMap = new Map(); // code -> Set(names)
  const me = ()=> (elName.value || '').trim();

  // Load sections + check-ins
  async function load() {
    const [sections, checkins] = await Promise.all([
      supabase.from('sections').select('*').order('code', { ascending: true }),
      supabase.from('checkins').select('code,name,active').eq('active', true)
    ]);

    if (sections.error) { show(`–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${sections.error.message}`, true); return; }
    if (checkins.error && checkins.error.message) {
      // —Ç–∞–±–ª–∏—Ü—ñ —â–µ –º–æ–∂–µ –Ω–µ –±—É—Ç–∏ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∂–µ–º–æ —Å–µ–∫—Ü—ñ—ó –±–µ–∑ –≤—ñ–¥–º—ñ—Ç–æ–∫
      console.warn('checkins error:', checkins.error.message);
    }

    // build map
    presentMap.clear();
    (checkins.data || []).forEach(row => {
      const key = row.code;
      if (!presentMap.has(key)) presentMap.set(key, new Set());
      presentMap.get(key).add(row.name);
    });

    render(sections.data || []);
  }

  function initials(n){
    const parts = (n || '').trim().split(/\s+/).slice(0,2);
    if (!parts.length) return '??';
    if (parts.length===1) return parts[0].slice(0,2).toUpperCase();
    return (parts[0][0] + parts[1][0]).toUpperCase();
  }

  function render(items) {
    elList.innerHTML = '';
    items.forEach(it => {
      const code = it.code;
      const ppl = Array.from(presentMap.get(code) || []);
      const iAmHere = ppl.includes(me());

      const row = document.createElement('div');
      row.className = 'row a-fade';

      // left: title
      const left = document.createElement('div');
      left.className = 'title';
      const dot = document.createElement('span');
      dot.className = 'dot ' + (it.status === 'red' ? 'red' : 'green');
      const ttl = document.createElement('div');
      ttl.className = 'ttl';
      ttl.textContent = `${it.code} ‚Äî ${it.title}`;
      left.appendChild(dot);
      left.appendChild(ttl);

      // right: status buttons
      const right = document.createElement('div');
      right.className = 'actions';
      const seg = document.createElement('div');
      seg.className = 'seg';
      const bRed = document.createElement('button');
      bRed.className = 'seg-btn danger';
      bRed.textContent = '–®–£–•–ï–†';
      bRed.onclick = () => changeStatus(code, 'red', dot);
      const bGreen = document.createElement('button');
      bGreen.className = 'seg-btn ok';
      bGreen.textContent = '–ó–µ–ª–µ–Ω–∏–π';
      bGreen.onclick = () => changeStatus(code, 'green', dot);
      seg.appendChild(bRed); seg.appendChild(bGreen);
      right.appendChild(seg);

      // who line: chips + check-in button
      const whoLine = document.createElement('div');
      whoLine.className = 'who-line';

      const chips = document.createElement('div');
      chips.className = 'chips';
      const count = document.createElement('span');
      count.className = 'chip chip-badge';
      count.textContent = `üë• ${ppl.length}`;
      chips.appendChild(count);

      ppl.forEach(n => {
        const chip = document.createElement('span');
        chip.className = 'chip' + (n === me() ? ' me' : '');
        chip.title = n;
        chip.textContent = `${initials(n)} ¬∑ ${n}`;
        chips.appendChild(chip);
      });

      const checkBtn = document.createElement('button');
      checkBtn.className = 'check-btn ' + (iAmHere ? 'ghost' : 'primary');
      checkBtn.textContent = iAmHere ? '–í–∏–π—Ç–∏' : '–Ø —Ç—É—Ç';
      checkBtn.onclick = () => toggleCheckIn(code, !iAmHere);

      whoLine.appendChild(chips);
      whoLine.appendChild(checkBtn);

      row.appendChild(left);
      row.appendChild(right);
      row.appendChild(whoLine);
      elList.appendChild(row);
    });
  }

  // Status change
  async function changeStatus(code, newStatus, dotEl) {
    const name = me();
    const password = (elPass.value || '').trim();
    if (!name) { show('–í–∫–∞–∂—ñ—Ç—å —ñ–º‚Äô—è', true); return; }
    if (!password) { show('–í–∫–∞–∂—ñ—Ç—å –ø–∞—Ä–æ–ª—å', true); return; }

    const prev = dotEl.classList.contains('red') ? 'red' : 'green';
    dotEl.classList.remove('red','green');
    dotEl.classList.add(newStatus === 'red' ? 'red' : 'green', 'pulse');

    try {
      const res = await fetch(SET_STATUS_FUNCTION_URL, {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ code, newStatus, name, password })
      });
      const json = await res.json();
      if (!res.ok) throw new Error(json?.error || res.statusText);
      show('–û–Ω–æ–≤–ª–µ–Ω–æ ‚úî');
      tg?.HapticFeedback?.impactOccurred?.('medium');
    } catch (e) {
      dotEl.classList.remove('red','green'); dotEl.classList.add(prev);
      show('–ü–æ–º–∏–ª–∫–∞: ' + e.message, true);
      tg?.HapticFeedback?.notificationOccurred?.('error');
    } finally {
      setTimeout(()=>dotEl.classList.remove('pulse'), 600);
    }
  }

  // Check-in / Check-out
  async function toggleCheckIn(code, present){
    const name = me();
    if (!name) { show('–í–∫–∞–∂—ñ—Ç—å —ñ–º‚Äô—è', true); return; }

    try {
      const res = await fetch(CHECK_IN_FUNCTION_URL, {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ code, name, present, password: elPass.value.trim() })
      });
      const json = await res.json().catch(()=> ({}));
      if (!res.ok) throw new Error(json?.error || res.statusText);
      show(present ? '–í—ñ–¥–º—ñ—á–µ–Ω–æ ‚úÖ' : '–í–∏—Ö—ñ–¥ ‚úÖ');
      tg?.HapticFeedback?.impactOccurred?.('light');
    } catch (e) {
      show('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–º—ñ—Ç–∫–∏: ' + e.message, true);
      tg?.HapticFeedback?.notificationOccurred?.('error');
    }
  }

  function show(text, isErr=false) {
    elMsg.className = 'footer-note msg ' + (isErr ? 'err-t' : 'ok-t');
    elMsg.textContent = text;
    clearTimeout(show._t);
    show._t = setTimeout(() => { elMsg.textContent = ''; }, 4000);
  }

  // Initial load:
  load();

  // Realtime: sections + checkins
  const debouncedReload = debounce(load, 150);
  supabase.channel('sections-realtime')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'sections' }, () => {
      debouncedReload(); tg?.HapticFeedback?.impactOccurred?.('light');
    })
    .subscribe();

  supabase.channel('checkins-realtime')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'checkins' }, () => {
      debouncedReload();
    })
    .subscribe();
</script>
</body>
</html>
