<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>–°—Ç–∞—Ç—É—Å–∏ ‚Äî Telegram WebApp</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#fff; --fg:#111; --muted:#6b7280; --line:#ececec;
    --ok:#18c964; --err:#ff3b30; --card:#fafafa; --tap:#f3f4f6;
    --radius:14px; --radius-sm:10px;
    --shadow:0 1px 3px rgba(0,0,0,.06), 0 1px 2px rgba(0,0,0,.04);
    --pad:16px; --gap:12px;
    --h1: clamp(18px, 4vw, 22px);
    --t1: clamp(14px, 3.6vw, 16px);
    --t2: clamp(12px, 3.2vw, 14px);
  }
  @media (prefers-reduced-motion: no-preference){
    .a-fade{ animation: fade .18s ease-out both; }
    @keyframes fade { from{opacity:.0; transform: translateY(4px)} to{opacity:1; transform:none} }
    .pulse { animation: pulse 1s ease-in-out 1; }
    @keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.15)} 100%{transform:scale(1)} }
  }
  html,body{ height:100%; }
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Segoe UI Emoji";
    background:var(--bg); color:var(--fg);
  }
  .wrap{ padding-bottom: max(12px, env(safe-area-inset-bottom)); max-width: 840px; margin: 0 auto; }

  /* Sticky top controls */
  .topbar{
    position: sticky; top:0; z-index:10;
    backdrop-filter: saturate(120%) blur(6px);
    background: color-mix(in oklab, var(--bg) 84%, transparent);
    border-bottom:1px solid var(--line);
    transition: transform .2s ease;
  }
  /* –ö–æ–ª–∏ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞ ‚Äî –∑–≤—ñ–ª—å–Ω—è—î–º–æ –±—ñ–ª—å—à–µ –º—ñ—Å—Ü—è —Å–ø–∏—Å–∫—É */
  body.kb-open .topbar { position: static; }

  .topbar-inner{ padding: calc(env(safe-area-inset-top) + 10px) var(--pad) 10px; }
  h1{ font-size:var(--h1); margin:0 0 8px; line-height:1.2; }
  .note{ color:var(--muted); font-size:var(--t2); margin:0 0 10px; }

  .controls{
    display:grid; gap:10px;
    grid-template-columns: 1fr 1fr auto;
    align-items:center;
  }
  @media (max-width:560px){ .controls{ grid-template-columns: 1fr; } }
  input{
    width:100%; padding:12px 12px; border:1px solid var(--line);
    border-radius: var(--radius-sm); background:var(--card); font-size:var(--t1); outline:none;
  }
  input:focus{ box-shadow: 0 0 0 2px color-mix(in oklab, var(--fg) 10%, transparent); }
  .btn{
    padding:12px 14px; border:1px solid var(--line); background:var(--tap);
    border-radius: var(--radius-sm); cursor:pointer; font-size:var(--t1);
    user-select:none; -webkit-tap-highlight-color: transparent;
  }
  .btn:active{ transform: translateY(1px); }
  .btn[disabled]{ opacity:.6; cursor:default; }
  .btn-primary{ background:var(--fg); color:var(--bg); border-color: var(--fg); }
  .who{ color:var(--muted); font-size:var(--t2); margin-top:6px; }

  /* Search */
  .search{margin-top:8px; width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:var(--card); font-size:var(--t1);}

  /* List */
  #list{ padding: 12px var(--pad); display:grid; gap:10px; }
  .row{
    display:grid; gap:10px;
    grid-template-columns: 1fr auto;
    align-items:start;
    border:1px solid var(--line);
    border-radius: var(--radius);
    padding:12px;
    background: var(--bg);
    box-shadow: var(--shadow);
    /* —â–æ–± scrollIntoView –Ω–µ —Ö–æ–≤–∞–≤ —Ä—è–¥–∫–∏ –ø—ñ–¥ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–æ—é */
    scroll-margin-bottom: 80px;
  }
  @media (max-width:680px){ .row{ grid-template-columns: 1fr; } }

  .title{ display:flex; align-items:center; gap:10px; min-width:0; }
  .dot{ flex:0 0 16px; width:16px; height:16px; border-radius:50%; box-shadow: 0 0 0 2px #00000010; }
  .green{ background: var(--ok); box-shadow: 0 0 0 2px color-mix(in oklab, var(--ok) 20%, transparent); }
  .red{ background: var(--err); box-shadow: 0 0 0 2px color-mix(in oklab, var(--err) 20%, transparent); }
  .ttl{ font-size:var(--t1); font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

  /* Actions: status + check-in */
  .actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .seg{
    display:flex; overflow:hidden; border-radius: 12px; border:1px solid var(--line); background: var(--card);
  }
  .seg .seg-btn{
    appearance:none; border:none; background:transparent; padding:12px 14px; font-size:var(--t1);
    cursor:pointer; min-width: 120px; text-align:center;
  }
  @media (max-width:560px){ .seg{ width:100%; } .seg .seg-btn{ flex:1; min-width:auto; } }
  .seg .seg-btn + .seg-btn{ border-left:1px solid var(--line); }
  .seg .danger{ color:var(--err); font-weight:600; }
  .seg .ok{ color:var(--ok); font-weight:600; }

  /* Pin */
  .pin{
    background:transparent; border:1px dashed var(--line); padding:8px 10px; border-radius:10px; font-size:var(--t2);
  }
  .pinned{ border-color: var(--ok); }

  /* Check-ins */
  .who-line{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .chips{
    display:flex; gap:6px; flex-wrap:wrap; align-items:center; max-width:100%;
  }
  .chip{
    display:inline-flex; align-items:center; justify-content:center;
    padding:6px 8px; border-radius:999px; background:var(--card);
    border:1px solid var(--line); font-size:var(--t2); line-height:1; white-space:nowrap;
  }
  .chip-badge{ font-weight:700; }
  .me{ border-color: color-mix(in oklab, var(--ok) 40%, var(--line)); background: color-mix(in oklab, var(--ok) 12%, var(--card)); }
  .check-btn{
    padding:10px 12px; border-radius:10px; border:1px solid var(--line);
    background:var(--tap); font-size:var(--t2);
  }
  .check-btn.primary{ background: var(--ok); color:#fff; border-color: var(--ok); }
  .check-btn.ghost{ background: transparent; }

  .footer-note{ color:var(--muted); font-size:var(--t2); padding: 0 var(--pad); margin: 6px 0 10px; }
  .msg { padding: 8px var(--pad) max(8px, env(safe-area-inset-bottom)); }
  .ok-t{ color:var(--ok); } .err-t{ color:var(--err); }

  /* Skeleton */
  .skeleton{ border:1px solid var(--line); border-radius: var(--radius); padding:12px; background: var(--card); position:relative; overflow:hidden; }
  .sk-line{ height:14px; background:linear-gradient(90deg, #eee, #f7f7f7, #eee); border-radius:8px; }
  .sk-gap{ height:10px; }
</style>
</head>
<body>
  <div class="wrap">

    <div class="topbar">
      <div class="topbar-inner">
        <h1>–û–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å–∏</h1>
        <p class="note">–ó–º—ñ–Ω–∏ –º–∏—Ç—Ç—î–≤–æ —Ä–æ–∑–ª—ñ—Ç–∞—é—Ç—å—Å—è –≤—Å—ñ–º –≤—ñ–¥–∫—Ä–∏—Ç–∏–º –µ–∫—Ä–∞–Ω–∞–º. –î–ª—è ‚Äú–®–£–•–ï–†‚Äù —É—Ç—Ä–∏–º—É–π 0.5 —Å–µ–∫ —ñ –≤–≤–µ–¥–∏ –ø–∞—Ä–æ–ª—å. –Ñ –ø–æ—à—É–∫ —ñ –∑–∞–∫—Ä—ñ–ø–ª–µ–Ω–Ω—è —Å–µ–∫—Ü—ñ–π üëá</p>

        <div class="controls">
          <input id="name" placeholder="–í–∞—à–µ —ñ–º‚Äô—è" inputmode="text" autocomplete="name" />
          <!-- –ø–∞—Ä–æ–ª—å: –∞–≤—Ç–æ–∑–∞–∫—Ä–∏—Ç—Ç—è –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ –ø—ñ—Å–ª—è 5 —Å–∏–º–≤–æ–ª—ñ–≤ -->
          <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å –¥–ª—è –∑–º—ñ–Ω"
                 autocomplete="one-time-code" inputmode="numeric"
                 enterkeyhint="done" maxlength="5" />
          <button id="refresh" class="btn btn-primary" type="button">–û–Ω–æ–≤–∏—Ç–∏</button>
        </div>
        <input id="search" class="search" placeholder="–ü–æ—à—É–∫ —Å–µ–∫—Ü—ñ—ó..." />
        <div class="who" id="who"></div>
      </div>
    </div>

    <div id="net" class="footer-note" style="display:none; color:#ff3b30;">–ù–µ–º–∞—î –∑ º—î–¥–Ω–∞–Ω–Ω—è. –ó–º—ñ–Ω–∏ –Ω–µ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ.</div>

    <div id="list">
      <div class="skeleton a-fade"><div class="sk-line" style="width:60%"></div><div class="sk-gap"></div><div class="sk-line" style="width:40%"></div></div>
      <div class="skeleton a-fade"><div class="sk-line" style="width:72%"></div><div class="sk-gap"></div><div class="sk-line" style="width:35%"></div></div>
    </div>

    <div class="footer-note">–ü—ñ—Å–ª—è ‚Äú–®–£–•–ï–†‚Äù –ª–µ—Ç–∏—Ç—å –±–æ—Ç-–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: <b>4.1 –®–£–•–ï–† (—ñ–º‚Äô—è)</b>. –í—ñ–¥–º—ñ—Ç–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—é—Ç—å—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ.</div>
    <div id="msg" class="footer-note msg"></div>
  </div>

<script>
  // Telegram theme ‚Üí CSS
  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.expand?.();
    const p = tg.themeParams || {};
    const map = (k, def) => p[k] || def;
    document.documentElement.style.setProperty('--bg',    map('bg_color', '#ffffff'));
    document.documentElement.style.setProperty('--fg',    map('text_color', '#111111'));
    document.documentElement.style.setProperty('--muted', map('hint_color', '#6b7280'));
    document.documentElement.style.setProperty('--line',  map('section_separator_color', '#ececec'));
  }

  // Supabase/Functions
  const SUPABASE_URL = 'https://xlrihkophbzbrsknimin.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhscmloa29waGJ6YnJza25pbWluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2NTc4OTksImV4cCI6MjA3NjIzMzg5OX0.mQBCCYgcbKwoN6HZjvmwGi4F995t0HZ9Ty3gZnjbtis';
  const SET_STATUS_FUNCTION_URL = 'https://xlrihkophbzbrsknimin.supabase.co/functions/v1/set-status';
  const CHECK_IN_FUNCTION_URL   = 'https://xlrihkophbzbrsknimin.supabase.co/functions/v1/check-in';

  const { createClient } = window.supabase;
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

  // Elements
  const elList = document.getElementById('list');
  const elMsg  = document.getElementById('msg');
  const elName = document.getElementById('name');
  const elPass = document.getElementById('password');
  const elWho  = document.getElementById('who');
  const elNet  = document.getElementById('net');
  const elSearch = document.getElementById('search');
  const btnRefresh = document.getElementById('refresh');

  // Prefill name from Telegram user + remember locally
  try {
    const u = tg?.initDataUnsafe?.user;
    if (u) {
      const full = [u.first_name, u.last_name].filter(Boolean).join(' ');
      elName.value = full || u.username || '';
    }
  } catch {}
  elName.value = localStorage.getItem('status_name') || elName.value || '';
  elWho.textContent = `–í–∏: ${elName.value || '‚Äî'}`;
  elName.addEventListener('input', () => {
    localStorage.setItem('status_name', elName.value.trim());
    elWho.textContent = `–í–∏: ${elName.value.trim() || '‚Äî'}`;
  });

  // Debounce
  function debounce(fn, ms=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
  const debouncedReload = debounce(load, 150);

  // Network banner
  function updateNetBanner(){ elNet.style.display = navigator.onLine ? 'none' : 'block'; }
  window.addEventListener('online', updateNetBanner);
  window.addEventListener('offline', updateNetBanner);
  updateNetBanner();

  // DATA STATE
  let presentMap = new Map(); // code -> Set(names)
  let pinned = new Set(JSON.parse(localStorage.getItem('pinned_codes')||'[]'));
  let lastItems = [];
  const me = ()=> (elName.value || '').trim();

  // Helpers
  function initials(n){
    const parts = (n || '').trim().split(/\s+/).slice(0,2);
    if (!parts.length) return '??';
    if (parts.length===1) return parts[0].slice(0,2).toUpperCase();
    return (parts[0][0] + parts[1][0]).toUpperCase();
  }
  function renderChips(ppl) {
    const chips = document.createElement('div');
    chips.className = 'chips';
    const count = document.createElement('span');
    count.className = 'chip chip-badge';
    count.textContent = `üë• ${ppl.length}`;
    chips.appendChild(count);

    const max = 4;
    ppl.slice(0, max).forEach(n => {
      const chip = document.createElement('span');
      chip.className = 'chip' + (n === me() ? ' me' : '');
      chip.title = n;
      chip.textContent = `${initials(n)} ¬∑ ${n}`;
      chips.appendChild(chip);
    });
    if (ppl.length > max) {
      const more = document.createElement('span');
      more.className = 'chip';
      more.textContent = `+${ppl.length - max}`;
      chips.appendChild(more);
    }
    return chips;
  }
  function extractErr(e, json){ return json?.error || json?.message || e?.message || '–ü–æ–º–∏–ª–∫–∞'; }
  function longPress(el, cb, holdMs=500){
    let t, down=false;
    const clear = ()=>{ down=false; clearTimeout(t); };
    el.addEventListener('touchstart', ()=>{down=true; t=setTimeout(()=>{ if(down) cb(); }, holdMs);},{passive:true});
    el.addEventListener('touchend', clear); el.addEventListener('touchcancel', clear);
    el.addEventListener('mousedown', ()=>{down=true; t=setTimeout(()=>{ if(down) cb(); }, holdMs);});
    el.addEventListener('mouseup', clear); el.addEventListener('mouseleave', clear);
  }
  async function withLoading(elOrFnArea, fn){
    // elOrFnArea: –∫–Ω–æ–ø–∫–∞ –∞–±–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–µ–≥–º–µ–Ω—Ç–∞
    const el = elOrFnArea;
    let prevText;
    if (el instanceof HTMLElement) {
      if (el.tagName === 'BUTTON') { prevText = el.textContent; el.disabled = true; el.textContent = '...'; }
      else { el.style.pointerEvents = 'none'; el.style.opacity = '.7'; }
    }
    try { return await fn(); }
    finally {
      if (el instanceof HTMLElement) {
        if (el.tagName === 'BUTTON') { el.disabled = false; el.textContent = prevText; }
        else { el.style.pointerEvents = ''; el.style.opacity = ''; }
      }
    }
  }

  // Load sections + check-ins
  async function load() {
    const [sections, checkins] = await Promise.all([
      supabase.from('sections').select('*').order('code', { ascending: true }),
      supabase.from('checkins').select('code,name,active').eq('active', true)
    ]);

    if (sections.error) { show(`–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${sections.error.message}`, true); return; }
    if (checkins.error && checkins.error.message) {
      console.warn('checkins error:', checkins.error.message);
    }

    presentMap.clear();
    (checkins.data || []).forEach(row => {
      const key = row.code;
      if (!presentMap.has(key)) presentMap.set(key, new Set());
      presentMap.get(key).add(row.name);
    });

    render(sections.data || []);
  }

  function togglePin(code){
    pinned.has(code)? pinned.delete(code): pinned.add(code);
    localStorage.setItem('pinned_codes', JSON.stringify(Array.from(pinned)));
    render(lastItems);
  }

  function render(items) {
    lastItems = items;
    const q = (elSearch.value||'').trim().toLowerCase();
    const filtered = q ? items.filter(it => (`${it.code} ${it.title}`).toLowerCase().includes(q)) : items;

    const sorted = [
      ...filtered.filter(it => pinned.has(it.code)),
      ...filtered.filter(it => !pinned.has(it.code))
    ];

    elList.innerHTML = '';
    sorted.forEach(it => {
      const code = it.code;
      const ppl = Array.from(presentMap.get(code) || []);
      const iAmHere = ppl.includes(me());

      const row = document.createElement('div');
      row.className = 'row a-fade';

      // left: title
      const left = document.createElement('div');
      left.className = 'title';
      const dot = document.createElement('span');
      dot.className = 'dot ' + (it.status === 'red' ? 'red' : 'green');
      const ttl = document.createElement('div');
      ttl.className = 'ttl';
      ttl.textContent = `${it.code} ‚Äî ${it.title}`;
      left.appendChild(dot);
      left.appendChild(ttl);

      // right: actions (segmented + pin)
      const right = document.createElement('div');
      right.className = 'actions';

      const seg = document.createElement('div');
      seg.className = 'seg';

      const bRed = document.createElement('button');
      bRed.className = 'seg-btn danger';
      bRed.type = 'button';
      bRed.textContent = '–®–£–•–ï–†';
      bRed.setAttribute('aria-label', `–£–≤—ñ–º–∫–Ω—É—Ç–∏ —á–µ—Ä–≤–æ–Ω–∏–π –¥–ª—è ${it.code}`);
      // long-press!
      longPress(bRed, () => changeStatus(code, 'red', dot, seg));

      const bGreen = document.createElement('button');
      bGreen.className = 'seg-btn ok';
      bGreen.type = 'button';
      bGreen.textContent = '–ó–µ–ª–µ–Ω–∏–π';
      bGreen.setAttribute('aria-label', `–ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –∑–µ–ª–µ–Ω–∏–π –¥–ª—è ${it.code}`);
      bGreen.onclick = () => changeStatus(code, 'green', dot, seg);

      seg.appendChild(bRed); seg.appendChild(bGreen);
      right.appendChild(seg);

      const pinBtn = document.createElement('button');
      pinBtn.className = 'pin' + (pinned.has(it.code) ? ' pinned' : '');
      pinBtn.type = 'button';
      pinBtn.textContent = pinned.has(it.code) ? '–ó–∞–∫—Ä—ñ–ø–ª–µ–Ω–æ' : '–ó–∞–∫—Ä—ñ–ø–∏—Ç–∏';
      pinBtn.onclick = () => togglePin(it.code);
      right.appendChild(pinBtn);

      // who line
      const whoLine = document.createElement('div');
      whoLine.className = 'who-line';

      const chips = renderChips(ppl);

      const checkBtn = document.createElement('button');
      checkBtn.className = 'check-btn ' + (iAmHere ? 'ghost' : 'primary');
      checkBtn.type = 'button';
      checkBtn.textContent = iAmHere ? '–í–∏–π—Ç–∏' : '–Ø —Ç—É—Ç';
      checkBtn.onclick = () => withLoading(checkBtn, () => toggleCheckIn(code, !iAmHere));

      whoLine.appendChild(chips);
      whoLine.appendChild(checkBtn);

      row.appendChild(left);
      row.appendChild(right);
      row.appendChild(whoLine);
      elList.appendChild(row);
    });
  }

  // Status change (with optimistic dot + loading on seg)
  async function changeStatus(code, newStatus, dotEl, segEl) {
    const name = me();
    const password = (elPass.value || '').trim();
    if (!name) { show('–í–∫–∞–∂—ñ—Ç—å —ñ–º‚Äô—è', true); return; }
    if (!password) { show('–í–∫–∞–∂—ñ—Ç—å –ø–∞—Ä–æ–ª—å', true); return; }

    const prev = dotEl.classList.contains('red') ? 'red' : 'green';
    dotEl.classList.remove('red','green');
    dotEl.classList.add(newStatus === 'red' ? 'red' : 'green', 'pulse');

    await withLoading(segEl, async () => {
      try {
        const res = await fetch(SET_STATUS_FUNCTION_URL, {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ code, newStatus, name, password })
        });
        const json = await res.json().catch(()=> ({}));
        if (!res.ok) throw new Error(extractErr(null, json));
        show('–û–Ω–æ–≤–ª–µ–Ω–æ ‚úî');
        tg?.HapticFeedback?.impactOccurred?.('medium');
      } catch (e) {
        dotEl.classList.remove('red','green'); dotEl.classList.add(prev);
        show('–ü–æ–º–∏–ª–∫–∞: ' + extractErr(e), true);
        tg?.HapticFeedback?.notificationOccurred?.('error');
      } finally {
        setTimeout(()=>dotEl.classList.remove('pulse'), 600);
      }
    });
  }

  // Check-in / Check-out
  async function toggleCheckIn(code, present){
    const name = me();
    if (!name) { show('–í–∫–∞–∂—ñ—Ç—å —ñ–º‚Äô—è', true); return; }

    try {
      const res = await fetch(CHECK_IN_FUNCTION_URL, {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ code, name, present, password: elPass.value.trim() })
      });
      const json = await res.json().catch(()=> ({}));
      if (!res.ok) throw new Error(extractErr(null, json));
      show(present ? '–í—ñ–¥–º—ñ—á–µ–Ω–æ ‚úÖ' : '–í–∏—Ö—ñ–¥ ‚úÖ');
      tg?.HapticFeedback?.impactOccurred?.('light');
    } catch (e) {
      show('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–º—ñ—Ç–∫–∏: ' + extractErr(e), true);
      tg?.HapticFeedback?.notificationOccurred?.('error');
    }
  }

  function show(text, isErr=false) {
    elMsg.className = 'footer-note msg ' + (isErr ? 'err-t' : 'ok-t');
    elMsg.textContent = text;
    clearTimeout(show._t);
    show._t = setTimeout(() => { elMsg.textContent = ''; }, 4000);
  }

  // Search & Refresh
  btnRefresh.addEventListener('click', () => load());
  elSearch.addEventListener('input', () => render(lastItems));

  // --- –ù–û–í–ï: –∞–≤—Ç–æ–∑–∞–∫—Ä–∏—Ç—Ç—è –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ —É –ø–æ–ª—ñ –ø–∞—Ä–æ–ª—è –ø—ñ—Å–ª—è 5 —Å–∏–º–≤–æ–ª—ñ–≤
  elPass.addEventListener('input', () => {
    const max = elPass.maxLength || 5;
    if (elPass.value.length >= max) {
      elPass.blur(); // –∑–∞–∫—Ä–∏—î —Å–æ—Ñ—Ç-–∫–ª–∞–≤—ñ–∞—Ç—É—Ä—É
      tg?.HapticFeedback?.impactOccurred?.('light');
    }
  });

  // --- –ù–û–í–ï: –∞–≤—Ç–æ—Å–∫—Ä–æ–ª –¥–æ –≤–∏–¥–∏–º–æ—ó –∑–æ–Ω–∏ –ø—Ä–∏ —Ñ–æ–∫—É—Å—ñ (fallback –Ω–∞ –≤–∏–ø–∞–¥–æ–∫ –±–µ–∑ visualViewport)
  ['name', 'password', 'search'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('focus', () => {
      setTimeout(() => {
        try { el.scrollIntoView({ block: 'center', behavior: 'smooth' }); } catch {}
      }, 150);
    });
  });

  // --- –ù–û–í–ï: ‚Äú—É—Ö–∏–ª—è–Ω–Ω—è‚Äù –≤—ñ–¥ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ —á–µ—Ä–µ–∑ VisualViewport
  (function keyboardDodge(){
    const vv = window.visualViewport;
    if (!vv) return;

    const wrap = document.querySelector('.wrap');

    function applySafeBottom() {
      // –í–∏—Å–æ—Ç–∞, —è–∫—É "–∑ º—ó–ª–∞" –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∞
      const kb = Math.max(0, window.innerHeight - vv.height);
      // –î–æ–¥–∞—î–º–æ –Ω–∏–∂–Ω—ñ–π –ø–∞–¥–¥—ñ–Ω–≥ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É, —â–æ–± –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ —Ö–æ–≤–∞–≤—Å—è –∑–∞ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–æ—é
      wrap.style.paddingBottom = `calc(${Math.ceil(kb)}px + max(12px, env(safe-area-inset-bottom)))`;

      // –ö–ª–∞—Å –¥–ª—è –¥—Ä—ñ–±–Ω–æ—ó –∞–¥–∞–ø—Ç–∞—Ü—ñ—ó (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –≤—ñ–¥–∫–ª—é—á–∏—Ç–∏ sticky topbar)
      document.body.classList.toggle('kb-open', kb > 0);

      // –ü—ñ–¥—Å–∫—Ä–æ–ª–∏—Ç–∏ –∞–∫—Ç–∏–≤–Ω–∏–π –µ–ª–µ–º–µ–Ω—Ç —É –∑–æ–Ω—É –≤–∏–¥–∏–º–æ—Å—Ç—ñ
      const active = document.activeElement;
      if (active && (active.tagName === 'INPUT' || active.tagName === 'BUTTON')) {
        setTimeout(() => {
          try { active.scrollIntoView({ block: 'center', behavior: 'smooth' }); } catch {}
        }, 50);
      }
    }

    vv.addEventListener('resize', applySafeBottom);
    vv.addEventListener('scroll', applySafeBottom);
    window.addEventListener('orientationchange', applySafeBottom);
    applySafeBottom();
  })();

  // Realtime: pause when hidden
  let subs = [];
  function subscribeRealtime(){
    unsubscribeRealtime();
    subs = [
      supabase.channel('sections-realtime')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'sections' }, () => debouncedReload())
        .subscribe(),
      supabase.channel('checkins-realtime')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'checkins' }, () => debouncedReload())
        .subscribe()
    ];
  }
  function unsubscribeRealtime(){
    subs.forEach(ch => { try{ ch.unsubscribe(); }catch{} });
    subs = [];
  }
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) unsubscribeRealtime();
    else { subscribeRealtime(); load(); }
  });

  // Initial load + subscribe
  load();
  subscribeRealtime();
</script>
</body>
</html>
