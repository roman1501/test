<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>–°—Ç–∞—Ç—É—Å–∏ ‚Äî Telegram WebApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#fff; --fg:#111; --muted:#6b7280; --line:#ececec;
      --ok:#18c964; --err:#ff3b30; --card:#fafafa; --tap:#f3f4f6;
      --chip-fg:var(--fg);
      --radius:14px; --radius-sm:10px;
      --shadow:0 1px 3px rgba(0,0,0,.06), 0 1px 2px rgba(0,0,0,.04);
      --pad:16px; --gap:12px;
      --h1: clamp(18px, 4vw, 22px);
      --t1: clamp(14px, 3.6vw, 16px);
      --t2: clamp(12px, 3.2vw, 14px);
    }
    @media (prefers-reduced-motion: no-preference){
      .a-fade{ animation: fade .18s ease-out both; }
      @keyframes fade { from{opacity:.0; transform: translateY(4px)} to{opacity:1; transform:none} }
      .pulse { animation: pulse 1s ease-in-out 1; }
      @keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.15)} 100%{transform:scale(1)} }
    }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Segoe UI Emoji";
      background:var(--bg); color:var(--fg);
    }
    .wrap{ padding-bottom: max(12px, env(safe-area-inset-bottom)); max-width: 840px; margin: 0 auto; }

    /* Sticky top controls */
    .topbar{
      position: sticky; top:0; z-index:10;
      backdrop-filter: saturate(120%) blur(6px);
      background: color-mix(in oklab, var(--bg) 75%, transparent);
      border-bottom: 1px solid var(--line);
    }
    .topbar-inner{ padding: 12px var(--pad) var(--gap); display:flex; flex-direction:column; gap: var(--gap); }
    h1{ font-size: var(--h1); margin: 0; }
    .note{ margin: 0; color: var(--muted); font-size: var(--t2); }

    .controls{ display:flex; gap: 8px; flex-wrap: wrap; }
    .controls input, .controls button{
      font-size: var(--t1); padding: 10px 12px; border-radius: var(--radius-sm);
      border: 1px solid var(--line); background: var(--card); color: var(--fg);
    }
    .controls input{ flex: 1 1 220px; min-width: 140px; }
    .btn{ cursor:pointer; }
    .btn-primary{ background: var(--ok); color: #fff; border-color: var(--ok); }

    .search{
      width: 100%; box-sizing: border-box; margin-top: 2px;
      padding: 10px 12px; border-radius: var(--radius-sm);
      border: 1px solid var(--line); background: var(--tap); font-size: var(--t1);
    }

    .who{ font-size: var(--t2); color: var(--muted); }

    /* List / rows */
    #list{ display: grid; gap: var(--gap); padding: var(--gap) var(--pad); }

    .row{
      border: 1px solid var(--line); border-radius: var(--radius);
      background: var(--card); box-shadow: var(--shadow);
      padding: 12px; display: grid; gap: 10px;
    }
    @media (min-width: 680px){
      .row{ grid-template-columns: 1fr auto; grid-template-areas:
        "left right"
        "who  who"
      }
    }
    @media (max-width: 679.98px){
      .row{ grid-template-columns: 1fr; grid-template-areas:
        "left"
        "right"
        "who"
      }
    }

    .title{ grid-area: left; display:flex; gap:10px; align-items:center; min-width: 0; }
    .dot{ width: 10px; height: 10px; border-radius: 50%; background: var(--ok); border:1px solid color-mix(in oklab, var(--fg) 12%, transparent); }
    .dot.red{ background: var(--err); }
    .dot.green{ background: var(--ok); }
    .ttl{ font-size: var(--t1); font-weight: 600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    .actions{ grid-area: right; display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap: wrap; }

    .seg{
      display:flex; border:1px solid var(--line); border-radius: 999px; overflow:hidden; background: #fff;
    }
    .seg .seg-btn{
      appearance:none; border:none; background:transparent; padding:12px 14px; font-size:var(--t1);
      cursor:pointer; min-width: 120px; text-align:center;
    }
    @media (max-width:560px){ .seg{ width:100%; } .seg .seg-btn{ flex:1; min-width:auto; } }
    .seg .seg-btn + .seg-btn{ border-left:1px solid var(--line); }
    .seg .danger{ color:var(--err); font-weight:600; }
    .seg .ok{ color:var(--ok); font-weight:600; }

    /* Pin */
    .pin{
      background:transparent; border:1px dashed var(--line); padding:8px 10px; border-radius:10px; font-size:var(--t2);
    }
    .pinned{ border-color: var(--ok); }

    /* Check-ins */
    .who-line{ grid-area: who; display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .chips{
      display:flex; gap:6px; flex-wrap:wrap; align-items:center; max-width:100%;
    }
    .chip{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 8px; border-radius:999px; background:var(--card);
      border:1px solid var(--line); font-size:var(--t2); line-height:1; white-space:nowrap;
      color:var(--chip-fg);
    }
    .chip-badge{ font-weight:700; }
    .me{ border-color: color-mix(in oklab, var(--ok) 40%, var(--line)); background: color-mix(in oklab, var(--ok) 12%, var(--card)); }
    .check-btn{
      padding:10px 12px; border-radius:10px; border:1px solid var(--line);
      background:var(--tap); font-size:var(--t2);
    }
    .check-btn.primary{ background: var(--ok); color:#fff; border-color: var(--ok); }
    .check-btn.ghost{ background: transparent; }

    .footer-note{ color:var(--muted); font-size:var(--t2); padding: 0 var(--pad); margin: 6px 0 10px; }
    .msg { padding: 8px var(--pad) max(8px, env(safe-area-inset-bottom)); }
    .ok-t{ color:var(--ok); } .err-t{ color:var(--err); }

    /* Skeleton */
    .skeleton{ border:1px solid var(--line); border-radius: var(--radius); padding:12px; background: var(--card); position:relative; overflow:hidden; }
    .sk-line{ height:14px; background:linear-gradient(90deg, #eee, #f7f7f7, #eee); border-radius:8px; }
    .sk-gap{ height:10px; }
  </style>
</head>
<body>
  <div class="wrap">

    <div class="topbar">
      <div class="topbar-inner">
        <h1>–û–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å–∏</h1>
        <p class="note">–ó–º—ñ–Ω–∏ –º–∏—Ç—Ç—î–≤–æ —Ä–æ–∑–ª—ñ—Ç–∞—é—Ç—å—Å—è –≤—Å—ñ–º –≤—ñ–¥–∫—Ä–∏—Ç–∏–º –µ–∫—Ä–∞–Ω–∞–º. –î–ª—è ‚Äú–®–£–•–ï–†‚Äù –≤–≤–µ–¥–∏ –ø–∞—Ä–æ–ª—å. –Ñ –ø–æ—à—É–∫ —ñ –∑–∞–∫—Ä—ñ–ø–ª–µ–Ω–Ω—è —Å–µ–∫—Ü—ñ–π üëá</p>

        <div class="controls">
          <input id="name" placeholder="–í–∞—à–µ —ñ–º‚Äô—è" inputmode="text" autocomplete="name" />
          <!-- –ø–∞—Ä–æ–ª—å: –∞–≤—Ç–æ–∑–∞–∫—Ä–∏—Ç—Ç—è –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ –ø—ñ—Å–ª—è 5 —Å–∏–º–≤–æ–ª—ñ–≤ -->
          <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å –¥–ª—è –∑–º—ñ–Ω"
                 autocomplete="one-time-code" inputmode="numeric"
                 enterkeyhint="done" maxlength="5" />
          <button id="refresh" class="btn btn-primary" type="button">–û–Ω–æ–≤–∏—Ç–∏</button>
        </div>
        <input id="search" class="search" placeholder="–ü–æ—à—É–∫ —Å–µ–∫—Ü—ñ—ó..." />
        <div class="who" id="who"></div>
      </div>
    </div>

    <div id="net" class="footer-note" style="display:none; color:#ff3b30;">–ù–µ–º–∞—î –∑ º—î–¥–Ω–∞–Ω–Ω—è. –ó–º—ñ–Ω–∏ –Ω–µ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ.</div>

    <div id="list">
      <div class="skeleton a-fade"><div class="sk-line" style="width:60%"></div><div class="sk-gap"></div><div class="sk-line" style="width:40%"></div></div>
      <div class="skeleton a-fade"><div class="sk-line" style="width:72%"></div><div class="sk-gap"></div><div class="sk-line" style="width:35%"></div></div>
    </div>

    <div class="footer-note">–ü—ñ—Å–ª—è ‚Äú–®–£–•–ï–†‚Äù –ª–µ—Ç–∏—Ç—å –±–æ—Ç-–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: <b>4.1 –®–£–•–ï–† (—ñ–º‚Äô—è)</b>. –í—ñ–¥–º—ñ—Ç–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—é—Ç—å—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ.</div>
    <div id="msg" class="footer-note msg"></div>
  </div>

<script>
  // Telegram theme ‚Üí CSS
  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.expand?.();
    const p = tg.themeParams || {};
    const map = (k, def) => p[k] || def;
    const textColor = map('text_color', '#111111');
    document.documentElement.style.setProperty('--bg',    map('bg_color', '#ffffff'));
    document.documentElement.style.setProperty('--fg',    textColor);
    document.documentElement.style.setProperty('--muted', map('hint_color', '#6b7280'));
    document.documentElement.style.setProperty('--line',  map('section_separator_color', '#ececec'));
    const isLightColor = color => {
      if (typeof color !== 'string') return false;
      const str = color.trim();
      let r, g, b;
      if (str.startsWith('#')) {
        let hex = str.slice(1);
        if (hex.length === 3) hex = hex.split('').map(c => c + c).join('');
        if (hex.length !== 6) return false;
        const num = parseInt(hex, 16);
        if (Number.isNaN(num)) return false;
        r = (num >> 16) & 255;
        g = (num >> 8) & 255;
        b = num & 255;
      } else {
        const match = str.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
        if (!match) return false;
        r = Number(match[1]);
        g = Number(match[2]);
        b = Number(match[3]);
      }
      const luminance = 0.2126 * r + 0.7152 * g + 0.0722 * b;
      return luminance > 180;
    };
    document.documentElement.style.setProperty('--chip-fg', textColor);
    if (isLightColor(textColor)) {
      document.documentElement.style.setProperty('--chip-fg', '#111111');
    }
  }

  // Supabase/Functions
  const SUPABASE_URL = 'https://xlrihkophbzbrsknimin.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhscmloa29waGJ6YnJza25pbWluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2NTc4OTksImV4cCI6MjA3NjIzMzg5OX0.mQBCCYgcbKwoN6HZjvmwGi4F995t0HZ9Ty3gZnjbtis';
  const SET_STATUS_FUNCTION_URL = 'https://xlrihkophbzbrsknimin.supabase.co/functions/v1/set-status';
  const CHECK_IN_FUNCTION_URL   = 'https://xlrihkophbzbrsknimin.supabase.co/functions/v1/check-in';

  const { createClient } = window.supabase;
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

  // Elements
  const elList = document.getElementById('list');
  const elMsg  = document.getElementById('msg');
  const elName = document.getElementById('name');
  const elPass = document.getElementById('password');
  const elWho  = document.getElementById('who');
  const elNet  = document.getElementById('net');
  const elSearch = document.getElementById('search');
  const btnRefresh = document.getElementById('refresh');

  // Prefill name from Telegram user + remember locally
  try {
    const u = tg?.initDataUnsafe?.user;
    if (u) {
      const first = [u.first_name, u.last_name].filter(Boolean).join(' ').trim();
      const full = first || u.username || '';
      elName.value = full;
    }
  } catch {}
  elName.value = localStorage.getItem('status_name') || elName.value || '';
  elWho.textContent = `–í–∏: ${elName.value || '‚Äî'}`;
  elName.addEventListener('input', () => {
    localStorage.setItem('status_name', elName.value.trim());
    elWho.textContent = `–í–∏: ${elName.value.trim() || '‚Äî'}`;
  });

  // Debounce
  function debounce(fn, ms=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
  const debouncedReload = debounce(load, 150);

  // Network banner
  function updateNetBanner(){ elNet.style.display = navigator.onLine ? 'none' : 'block'; }
  window.addEventListener('online', updateNetBanner);
  window.addEventListener('offline', updateNetBanner);
  updateNetBanner();

  // DATA STATE
  let presentMap = new Map(); // code -> Set(names)
  let pinned = new Set(JSON.parse(localStorage.getItem('pinned_codes')||'[]'));
  let lastSections = []; // cached sections rows
  const me = ()=> (elName.value || '').trim();
  const STATUS_COOLDOWN_MS = 2500;
  const statusCooldowns = new Map();

  // Helpers
  function initials(n){
    const parts = (n || '').trim().split(/\s+/).slice(0,2);
    if (!parts.length) return '??';
    if (parts.length===1) return parts[0].slice(0,2).toUpperCase();
    return (parts[0][0] + parts[1][0]).toUpperCase();
  }
  function renderChips(ppl) {
    const chips = document.createElement('div');
    chips.className = 'chips';
    const count = document.createElement('span');
    count.className = 'chip chip-badge';
    count.textContent = `üë• ${ppl.length}`;
    chips.appendChild(count);

    const max = 4;
    ppl.slice(0, max).forEach(n => {
      const chip = document.createElement('span');
      chip.className = 'chip' + (n === me() ? ' me' : '');
      chip.title = n;
      chip.textContent = `${initials(n)} ¬∑ ${n}`;
      chips.appendChild(chip);
    });
    if (ppl.length > max) {
      const more = document.createElement('span');
      more.className = 'chip';
      more.textContent = `+${ppl.length - max}`;
      chips.appendChild(more);
    }
    return chips;
  }
  function extractErr(e, json){ return json?.error || json?.message || e?.message || '–ü–æ–º–∏–ª–∫–∞'; }

  async function withLoading(elOrFnArea, fn){
    const el = elOrFnArea;
    let prevText;
    if (el instanceof HTMLElement) {
      if (el.tagName === 'BUTTON') { prevText = el.textContent; el.disabled = true; el.textContent = '...'; }
      else { el.style.pointerEvents = 'none'; el.style.opacity = '.7'; }
    }
    try { return await fn(); }
    finally {
      if (el instanceof HTMLElement) {
        if (el.tagName === 'BUTTON') { el.disabled = false; el.textContent = prevText; }
        else { el.style.pointerEvents = ''; el.style.opacity = ''; }
      }
    }
  }

  // UI msg
  let msgTimer;
  function show(text, isErr=false){
    clearTimeout(msgTimer);
    elMsg.textContent = text;
    elMsg.className = 'footer-note msg ' + (isErr ? 'err-t' : 'ok-t');
    msgTimer = setTimeout(()=> { elMsg.textContent=''; elMsg.className='footer-note msg'; }, 2800);
  }

  // Load sections + check-ins
  async function load() {
    // skeleton
    elList.innerHTML = `
      <div class="skeleton a-fade"><div class="sk-line" style="width:60%"></div><div class="sk-gap"></div><div class="sk-line" style="width:40%"></div></div>
      <div class="skeleton a-fade"><div class="sk-line" style="width:72%"></div><div class="sk-gap"></div><div class="sk-line" style="width:35%"></div></div>
    `;

    const [sections, checkins] = await Promise.all([
      supabase.from('sections').select('*').order('code', { ascending: true }),
      supabase.from('checkins').select('code,name,active').eq('active', true)
    ]);

    if (sections.error) { show(`–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${sections.error.message}`, true); return; }
    if (checkins.error) { show(`–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–º—ñ—Ç–æ–∫: ${checkins.error.message}`, true); return; }

    // Build present map
    presentMap = new Map();
    for (const row of checkins.data || []) {
      if (!row.active) continue;
      const set = presentMap.get(row.code) || new Set();
      if (row.name) set.add(row.name);
      presentMap.set(row.code, set);
    }

    lastSections = sections.data || [];
    render();
  }

  // Render list using cached lastSections + presentMap + search + pinned
  function render(){
    const q = (elSearch.value || '').trim().toLowerCase();
    let items = lastSections.slice();

    if (q) {
      items = items.filter(it => {
        const s1 = `${it.code} ${it.title}`.toLowerCase();
        return s1.includes(q);
      });
    }

    // Sort by pinned first, then by code asc (already asc), but stable
    items.sort((a,b)=>{
      const ap = pinned.has(a.code) ? 0 : 1;
      const bp = pinned.has(b.code) ? 0 : 1;
      if (ap !== bp) return ap - bp;
      return 0;
    });

    elList.innerHTML = '';
    items.forEach(it => {
      const code = it.code;
      const ppl = Array.from(presentMap.get(code) || []).sort((a,b)=>a.localeCompare(b, 'uk'));
      const iAmHere = ppl.includes(me());

      const row = document.createElement('div');
      row.className = 'row a-fade';

      // left: title
      const left = document.createElement('div');
      left.className = 'title';
      const dot = document.createElement('span');
      dot.className = 'dot ' + (it.status === 'red' ? 'red' : 'green');
      const ttl = document.createElement('div');
      ttl.className = 'ttl';
      ttl.textContent = `${it.code} ‚Äî ${it.title}`;
      left.appendChild(dot);
      left.appendChild(ttl);

      // right: actions (segmented + pin)
      const right = document.createElement('div');
      right.className = 'actions';

      const seg = document.createElement('div');
      seg.className = 'seg';

      const bRed = document.createElement('button');
      bRed.className = 'seg-btn danger';
      bRed.type = 'button';
      bRed.textContent = '–®–£–•–ï–†';
      bRed.setAttribute('aria-label', `–£–≤—ñ–º–∫–Ω—É—Ç–∏ —á–µ—Ä–≤–æ–Ω–∏–π –¥–ª—è ${it.code}`);
      bRed.dataset.status = 'red';
      bRed.disabled = it.status === 'red';
      bRed.onclick = () => changeStatus(code, 'red', dot, seg);

      const bGreen = document.createElement('button');
      bGreen.className = 'seg-btn ok';
      bGreen.type = 'button';
      bGreen.textContent = '–ó–µ–ª–µ–Ω–∏–π';
      bGreen.setAttribute('aria-label', `–ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –∑–µ–ª–µ–Ω–∏–π –¥–ª—è ${it.code}`);
      bGreen.dataset.status = 'green';
      bGreen.disabled = it.status === 'green';
      bGreen.onclick = () => changeStatus(code, 'green', dot, seg);

      seg.appendChild(bRed); seg.appendChild(bGreen);
      right.appendChild(seg);

      const pinBtn = document.createElement('button');
      pinBtn.className = 'pin' + (pinned.has(it.code) ? ' pinned' : '');
      pinBtn.type = 'button';
      pinBtn.textContent = pinned.has(it.code) ? '–ó–∞–∫—Ä—ñ–ø–ª–µ–Ω–æ' : '–ó–∞–∫—Ä—ñ–ø–∏—Ç–∏';
      pinBtn.onclick = () => togglePin(it.code);
      right.appendChild(pinBtn);

      // who line
      const whoLine = document.createElement('div');
      whoLine.className = 'who-line';

      const chips = renderChips(ppl);

      const checkBtn = document.createElement('button');
      checkBtn.className = 'check-btn ' + (iAmHere ? 'ghost' : 'primary');
      checkBtn.type = 'button';
      checkBtn.textContent = iAmHere ? '–í–∏–π—Ç–∏' : '–Ø —Ç—É—Ç';
      checkBtn.onclick = () => withLoading(checkBtn, () => toggleCheckIn(code, !iAmHere));

      whoLine.appendChild(chips);
      whoLine.appendChild(checkBtn);

      row.appendChild(left);
      row.appendChild(right);
      row.appendChild(whoLine);
      elList.appendChild(row);
    });

    if (!items.length) {
      elList.innerHTML = `<div class="footer-note" style="padding:12px var(--pad);">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞ –∑–∞–ø–∏—Ç–æ–º.</div>`;
    }
  }

  // Status change (with optimistic dot + loading on seg)
  async function changeStatus(code, newStatus, dotEl, segEl) {
    const name = me();
    const password = (elPass.value || '').trim();
    if (!name) { show('–í–∫–∞–∂—ñ—Ç—å —ñ–º‚Äô—è', true); return; }
    if (!password) { show('–í–∫–∞–∂—ñ—Ç—å –ø–∞—Ä–æ–ª—å', true); return; }

    const prev = dotEl.classList.contains('red') ? 'red' : 'green';
    if (prev === newStatus) {
      show('–°—Ç–∞—Ç—É—Å –≤–∂–µ –∞–∫—Ç—É–∞–ª—å–Ω–∏–π', true);
      tg?.HapticFeedback?.notificationOccurred?.('warning');
      return;
    }

    const now = Date.now();
    const last = statusCooldowns.get(code) || 0;
    if (now - last < STATUS_COOLDOWN_MS) {
      show('–ó–∞—á–µ–∫–∞–π —Ç—Ä–æ—Ö–∏ –ø–µ—Ä–µ–¥ –Ω–æ–≤–æ—é –∑–º—ñ–Ω–æ—é', true);
      tg?.HapticFeedback?.notificationOccurred?.('warning');
      return;
    }

    dotEl.classList.remove('red','green');
    dotEl.classList.add(newStatus === 'red' ? 'red' : 'green', 'pulse');

    await withLoading(segEl, async () => {
      try {
        const res = await fetch(SET_STATUS_FUNCTION_URL, {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ code, newStatus, name, password })
        });
        const json = await res.json().catch(()=> ({}));
        if (!res.ok) throw new Error(extractErr(null, json));
        show('–û–Ω–æ–≤–ª–µ–Ω–æ ‚úî');
        tg?.HapticFeedback?.impactOccurred?.('medium');
        statusCooldowns.set(code, Date.now());
        segEl.querySelectorAll('.seg-btn').forEach(btn => {
          const btnStatus = btn.dataset.status;
          if (!btnStatus) return;
          btn.disabled = btnStatus === newStatus;
        });
      } catch (e) {
        dotEl.classList.remove('red','green'); dotEl.classList.add(prev);
        segEl.querySelectorAll('.seg-btn').forEach(btn => {
          const btnStatus = btn.dataset.status;
          if (!btnStatus) return;
          btn.disabled = btnStatus === prev;
        });
        show('–ü–æ–º–∏–ª–∫–∞: ' + extractErr(e), true);
        tg?.HapticFeedback?.notificationOccurred?.('error');
      } finally {
        setTimeout(()=>dotEl.classList.remove('pulse'), 600);
      }
    });
  }

  // Check-in / Check-out
  async function toggleCheckIn(code, present){
    const name = me();
    if (!name) { show('–í–∫–∞–∂—ñ—Ç—å —ñ–º‚Äô—è', true); return; }

    try {
      const res = await fetch(CHECK_IN_FUNCTION_URL, {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ code, name, present, password: elPass.value.trim() })
      });
      const json = await res.json().catch(()=> ({}));
      if (!res.ok) throw new Error(extractErr(null, json));
      show(present ? '–í—ñ–¥–º—ñ—á–µ–Ω–æ ‚úÖ' : '–í–∏—Ö—ñ–¥ ‚úÖ');
      tg?.HapticFeedback?.impactOccurred?.('light');
      // Refresh presence quickly
      debouncedReload();
    } catch (e) {
      show('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–º—ñ—Ç–∫–∏: ' + extractErr(e), true);
      tg?.HapticFeedback?.notificationOccurred?.('error');
    }
  }

  // Pin/unpin
  function togglePin(code){
    if (pinned.has(code)) pinned.delete(code); else pinned.add(code);
    localStorage.setItem('pinned_codes', JSON.stringify(Array.from(pinned)));
    render();
  }

  // Search
  elSearch.addEventListener('input', debounce(render, 120));

  // Manual refresh
  btnRefresh.addEventListener('click', () => load());

  // Enter on password hides keyboard in mobile Telegram after 5 chars
  elPass.addEventListener('input', () => {
    if (elPass.value.length >= elPass.maxLength) {
      elPass.blur?.();
    }
  });

  // Realtime updates
  try {
    supabase
      .channel('statuses-sections')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'sections' }, () => debouncedReload())
      .on('postgres_changes', { event: '*', schema: 'public', table: 'checkins' }, () => debouncedReload())
      .subscribe((status) => {
        if (status === 'SUBSCRIBED') {
          // no-op
        }
      });
  } catch {}

  // Initial
  load();
  window.addEventListener('focus', debouncedReload);
</script>
</body>
</html>
